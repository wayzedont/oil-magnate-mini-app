<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å - –ù–µ—Ñ—Ç—è–Ω–æ–π –º–∞–≥–Ω–∞—Ç</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Firebase -->
    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
      import { getFirestore, collection, query, getDocs, doc, updateDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
      const firebaseConfig = {
        apiKey: "AIzaSyDzN2GdDHsPmsxs-0KyWtfFFIBsdhezFrg",
        authDomain: "renaissance-8a16f.firebaseapp.com",
        projectId: "renaissance-8a16f",
        storageBucket: "renaissance-8a16f.firebasestorage.app",
        messagingSenderId: "172376303650",
        appId: "1:172376303650:web:7e9e18edfe957e131a427b",
        measurementId: "G-G8WMLBPJ0D"
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      window.db = getFirestore(app);
      window.query = query;
      window.getDocs = getDocs;
      window.doc = doc;
      window.updateDoc = updateDoc;
      window.deleteDoc = deleteDoc;
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1e 100%);
            color: #ffffff;
            padding: 20px;
        }

        .header {
            background: #252541;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
        }

        .header h1 {
            color: #ffd700;
            font-size: 24px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #252541;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #3a3a5a;
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #ffd700;
            margin: 10px 0;
        }

        .players-table {
            background: #252541;
            border-radius: 12px;
            border: 2px solid #3a3a5a;
            overflow: hidden;
        }

        .table-header {
            background: #ffd700;
            color: #1a1a2e;
            padding: 15px;
            font-weight: bold;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr 150px;
            gap: 10px;
        }

        .player-row {
            padding: 15px;
            border-bottom: 1px solid #3a3a5a;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr 150px;
            gap: 10px;
            align-items: center;
        }

        .player-row:last-child {
            border-bottom: none;
        }

        .player-name {
            font-weight: bold;
            color: #ffd700;
        }

        .player-money {
            color: #4caf50;
            font-weight: bold;
        }

        .player-oil {
            color: #2196f3;
        }

        .btn-reset {
            background: #f44336;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .btn-reset:hover {
            background: #d32f2f;
            transform: scale(1.05);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #a0a0b8;
        }

        .no-players {
            text-align: center;
            padding: 40px;
            color: #a0a0b8;
        }

        .refresh-btn {
            background: #ffd700;
            color: #1a1a2e;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .refresh-btn:hover {
            background: #ffb800;
        }

        @media (max-width: 768px) {
            .table-header, .player-row {
                grid-template-columns: 1fr;
                gap: 5px;
            }

            .table-header {
                display: none;
            }

            .player-row {
                background: #1a1a2e;
                margin-bottom: 10px;
                border-radius: 8px;
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üëë –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å - –ù–µ—Ñ—Ç—è–Ω–æ–π –º–∞–≥–Ω–∞—Ç</h1>
    </div>

    <button class="refresh-btn" onclick="loadPlayers()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤</button>

    <div class="stats">
        <div class="stat-card">
            <div>–í—Å–µ–≥–æ –∏–≥—Ä–æ–∫–æ–≤</div>
            <div class="stat-value" id="totalPlayers">0</div>
        </div>
        <div class="stat-card">
            <div>–ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ–≥–æ–¥–Ω—è</div>
            <div class="stat-value" id="activeToday">0</div>
        </div>
        <div class="stat-card">
            <div>–û–±—â–∏–π –±–∞–ª–∞–Ω—Å</div>
            <div class="stat-value" id="totalMoney">0‚ÇΩ</div>
        </div>
        <div class="stat-card">
            <div>–û–±—â–µ–µ –º–∞—Å–ª–æ</div>
            <div class="stat-value" id="totalOil">0 –±.</div>
        </div>
    </div>

    <div class="players-table">
        <div class="table-header">
            <div>–ò–º—è –∏–≥—Ä–æ–∫–∞</div>
            <div>–£—Ä–æ–≤–µ–Ω—å</div>
            <div>–î–µ–Ω—å–≥–∏</div>
            <div>–ú–∞—Å–ª–æ</div>
            <div>–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
            <div>–î–µ–π—Å—Ç–≤–∏—è</div>
        </div>
        <div id="playersList">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–≥—Ä–æ–∫–æ–≤...</div>
        </div>
    </div>

    <script>
        let allPlayers = [];

        async function loadPlayers() {
            try {
                const playersList = document.getElementById('playersList');
                playersList.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–≥—Ä–æ–∫–æ–≤...</div>';

                const q = query(collection(window.db, 'players'));
                const querySnapshot = await getDocs(q);

                allPlayers = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    allPlayers.push({
                        id: doc.id,
                        ...data
                    });
                });

                // Sort by last active (newest first)
                allPlayers.sort((a, b) => new Date(b.lastActive.toDate()) - new Date(a.lastActive.toDate()));

                updateStats();
                renderPlayers();
            } catch (error) {
                console.error('Error loading players:', error);
                document.getElementById('playersList').innerHTML = '<div class="no-players">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</div>';
            }
        }

        function updateStats() {
            const totalPlayers = allPlayers.length;
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

            const activeToday = allPlayers.filter(p => {
                const lastActive = p.lastActive.toDate();
                return lastActive >= today;
            }).length;

            const totalMoney = allPlayers.reduce((sum, p) => sum + (p.gameData?.state?.money || 0), 0);
            const totalOil = allPlayers.reduce((sum, p) => sum + (p.gameData?.state?.availableOil || 0), 0);

            document.getElementById('totalPlayers').textContent = totalPlayers;
            document.getElementById('activeToday').textContent = activeToday;
            document.getElementById('totalMoney').textContent = formatNumber(totalMoney) + '‚ÇΩ';
            document.getElementById('totalOil').textContent = formatNumber(totalOil) + ' –±.';
        }

        function renderPlayers() {
            if (allPlayers.length === 0) {
                document.getElementById('playersList').innerHTML = '<div class="no-players">–ò–≥—Ä–æ–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }

            const playersHtml = allPlayers.map(player => {
                const money = player.gameData?.state?.money || 0;
                const oil = player.gameData?.state?.availableOil || 0;
                const level = player.level || 1;
                const levelName = player.levelName || '–ù–æ–≤–∏—á–æ–∫';
                const lastActive = player.lastActive?.toDate();

                const timeAgo = lastActive ? getTimeAgo(lastActive) : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';

                return `
                    <div class="player-row">
                        <div class="player-name">${player.playerName} (ID: ${player.playerId})</div>
                        <div>${level} - ${levelName}</div>
                        <div class="player-money">${formatNumber(money)}‚ÇΩ</div>
                        <div class="player-oil">${formatNumber(oil)} –±.</div>
                        <div>${timeAgo}</div>
                        <div><button class="btn-reset" onclick="resetPlayer('${player.playerId}')">–°–±—Ä–æ—Å–∏—Ç—å</button></div>
                    </div>
                `;
            }).join('');

            document.getElementById('playersList').innerHTML = playersHtml;
        }

        async function resetPlayer(playerId) {
            if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –∏–≥—Ä–æ–∫–∞ ${playerId}?`)) {
                return;
            }

            try {
                const defaultState = {
                    money: 0,
                    clickPower: 1,
                    clickSkillLevel: 1,
                    lands: [],
                    availableOil: 0,
                    generationHistory: [],
                    companies: [],
                    analyzedLands: [],
                    rigSlots: 2,
                    purchasedSlots: 0,
                    companyContracts: {},
                    lastOnlineTime: Date.now(),
                    offlineProgress: 0,
                    ownCompany: null,
                    events: [],
                    priceMultiplier: 1.0,
                    priceMultiplierEndTime: 0,
                    achievements: [],
                    totalPlayTime: 0,
                    playerLevel: 1,
                    playerLevelName: '–ù–æ–≤–∏—á–æ–∫'
                };

                const playerRef = doc(window.db, 'players', playerId);
                await updateDoc(playerRef, {
                    gameData: {
                        state: defaultState,
                        version: '1.2',
                        savedAt: Date.now(),
                        checksum: generateChecksum(defaultState)
                    },
                    lastActive: new Date()
                });

                alert('–ü—Ä–æ–≥—Ä–µ—Å—Å –∏–≥—Ä–æ–∫–∞ —Å–±—Ä–æ—à–µ–Ω!');
                loadPlayers(); // Refresh the list
            } catch (error) {
                console.error('Error resetting player:', error);
                alert('–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞');
            }
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

            if (diffMins < 1) return '–¢–æ–ª—å–∫–æ —á—Ç–æ';
            if (diffMins < 60) return `${diffMins} –º–∏–Ω –Ω–∞–∑–∞–¥`;
            if (diffHours < 24) return `${diffHours} —á –Ω–∞–∑–∞–¥`;
            return `${diffDays} –¥ –Ω–∞–∑–∞–¥`;
        }

        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return Math.floor(num).toString();
        }

        function generateChecksum(state) {
            const str = JSON.stringify(state);
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString();
        }

        // Load players on page load
        document.addEventListener('DOMContentLoaded', loadPlayers);
    </script>
</body>
</html>